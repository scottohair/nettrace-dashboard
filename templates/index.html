<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NetTrace - Network Traceroute Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
<script src="https://js.stripe.com/v3/"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'SF Mono','Fira Code','Consolas',monospace;background:#0a0e17;color:#c8d6e5;overflow-x:hidden}
.header{background:linear-gradient(135deg,#0d1321,#1a1a2e);border-bottom:1px solid #1e3a5f;padding:12px 20px;display:flex;align-items:center;justify-content:space-between;height:56px}
.header h1{font-size:16px;color:#00d4ff;letter-spacing:1px;display:flex;align-items:center;gap:8px}
.header h1 .dot{width:8px;height:8px;border-radius:50%;background:#00ff88;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.header-right{display:flex;align-items:center;gap:16px}
.stats{display:flex;gap:20px;font-size:11px}
.stat-item{text-align:center}
.stat-value{font-size:18px;font-weight:700;color:#00ff88}
.stat-label{color:#5a6c7d;text-transform:uppercase;letter-spacing:1px;font-size:9px}
.user-area{display:flex;align-items:center;gap:10px}
.user-badge{padding:4px 10px;background:#00d4ff15;border:1px solid #00d4ff44;border-radius:4px;font-size:11px;color:#00d4ff}
.sub-badge{padding:4px 8px;background:#00ff8822;border:1px solid #00ff8844;border-radius:4px;font-size:10px;color:#00ff88}
.btn{padding:6px 14px;border:1px solid #1e3a5f;border-radius:4px;background:transparent;color:#c8d6e5;font-family:inherit;font-size:11px;cursor:pointer;transition:all .2s}
.btn:hover{border-color:#00d4ff;color:#00d4ff}
.btn-primary{background:#00d4ff22;border-color:#00d4ff;color:#00d4ff}
.btn-primary:hover{background:#00d4ff33}
.btn-danger{border-color:#ef4444;color:#ef4444}
.btn-danger:hover{background:#ef444422}
.btn-stripe{background:linear-gradient(135deg,#635bff22,#635bff44);border-color:#635bff;color:#a78bfa}
.btn-stripe:hover{background:#635bff44}
.main{display:grid;grid-template-columns:320px 1fr;grid-template-rows:55vh 1fr;height:calc(100vh - 56px)}
.past-due-banner:not(.hidden)~.main{height:calc(100vh - 56px - 30px)}
.sidebar{grid-row:1/3;background:#0d1321;border-right:1px solid #1e3a5f;overflow-y:auto;display:flex;flex-direction:column}
.sidebar::-webkit-scrollbar{width:5px}
.sidebar::-webkit-scrollbar-track{background:#0d1321}
.sidebar::-webkit-scrollbar-thumb{background:#1e3a5f;border-radius:3px}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:#000a;z-index:1000;display:flex;align-items:center;justify-content:center}
.modal{background:#0d1321;border:1px solid #1e3a5f;border-radius:8px;padding:24px;width:360px;max-width:90vw}
.modal h2{font-size:16px;color:#00d4ff;margin-bottom:16px}
.modal input{width:100%;padding:8px 12px;background:#111827;border:1px solid #1e3a5f;border-radius:4px;color:#c8d6e5;font-family:inherit;font-size:12px;margin-bottom:10px;outline:none}
.modal input:focus{border-color:#00d4ff}
.modal .btn{width:100%;margin-bottom:8px}
.modal .error{color:#ef4444;font-size:11px;margin-bottom:8px}
.modal .switch{text-align:center;font-size:11px;color:#5a6c7d;cursor:pointer}
.modal .switch a{color:#00d4ff;text-decoration:none}
.hidden{display:none!important}

/* Toast */
.toast-container{position:fixed;top:70px;right:20px;z-index:2000;display:flex;flex-direction:column;gap:8px}
.toast{padding:10px 16px;border-radius:6px;font-size:12px;font-family:inherit;animation:toastIn .3s ease;max-width:340px;border:1px solid #1e3a5f;background:#0d1321;color:#c8d6e5}
.toast-success{border-color:#00ff8866;background:#00ff8811;color:#00ff88}
.toast-error{border-color:#ef444466;background:#ef444411;color:#ef4444}
.toast-warning{border-color:#f59e0b66;background:#f59e0b11;color:#f59e0b}
@keyframes toastIn{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}

/* Past due banner */
.past-due-banner{background:#f59e0b18;border-bottom:1px solid #f59e0b44;padding:6px 20px;font-size:11px;color:#f59e0b;text-align:center}

/* Settings Modal */
.settings-modal{width:400px;max-width:90vw;max-height:85vh;overflow-y:auto}
.settings-section{margin-bottom:18px}
.settings-section h3{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#5a6c7d;margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid #1e3a5f}
.settings-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;font-size:12px}
.settings-label{color:#5a6c7d}
.settings-value{color:#c8d6e5}
.status-badge{padding:3px 8px;border-radius:3px;font-size:10px;font-weight:600}
.status-active{background:#00ff8822;color:#00ff88;border:1px solid #00ff8844}
.status-past-due{background:#f59e0b22;color:#f59e0b;border:1px solid #f59e0b44}
.status-cancelled{background:#f59e0b22;color:#f59e0b;border:1px solid #f59e0b44}
.status-expired{background:#ef444422;color:#ef4444;border:1px solid #ef444444}
.status-inactive{background:#37415122;color:#5a6c7d;border:1px solid #37415144}
.crypto-warning{background:#f59e0b11;border:1px solid #f59e0b33;border-radius:4px;padding:8px;font-size:11px;color:#f59e0b;margin-top:8px}
.settings-actions{display:flex;flex-direction:column;gap:8px;margin-top:14px}
.btn-settings{width:100%;padding:8px;font-size:12px}

/* Paywall */
.paywall{padding:20px;text-align:center}
.paywall h3{font-size:14px;color:#00d4ff;margin-bottom:8px}
.paywall p{font-size:11px;color:#5a6c7d;margin-bottom:14px;line-height:1.5}
.paywall .price{font-size:24px;font-weight:700;color:#00ff88;margin-bottom:4px}
.paywall .price-sub{font-size:10px;color:#5a6c7d;margin-bottom:14px}
.paywall .features{text-align:left;font-size:11px;margin-bottom:16px;padding-left:20px}
.paywall .features li{margin-bottom:4px;color:#c8d6e5}
.paywall .features li::marker{color:#00ff88}

/* Scan bar */
.scan-bar{padding:10px 14px;border-bottom:1px solid #1e3a5f;background:#111827}
.scan-bar h3{font-size:10px;color:#5a6c7d;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.scan-input-row{display:flex;gap:6px}
.scan-input-row input{flex:1;padding:6px 10px;background:#0a0e17;border:1px solid #1e3a5f;border-radius:4px;color:#c8d6e5;font-family:inherit;font-size:11px;outline:none}
.scan-input-row input:focus{border-color:#00d4ff}
.scan-status{font-size:10px;margin-top:6px;color:#5a6c7d}
.scan-status.running{color:#f59e0b}
.scan-status.done{color:#00ff88}
.scan-status.err{color:#ef4444}
.presets{padding:8px 14px;border-bottom:1px solid #1e3a5f}
.presets h3{font-size:10px;color:#5a6c7d;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.preset-chips{display:flex;flex-wrap:wrap;gap:4px}
.preset-chip{padding:3px 8px;border:1px solid #1e3a5f;border-radius:3px;font-size:10px;cursor:pointer;color:#5a6c7d;transition:all .2s}
.preset-chip:hover{border-color:#00d4ff;color:#00d4ff}
.filter-bar{display:flex;gap:6px;padding:8px 14px;border-bottom:1px solid #1e3a5f;flex-shrink:0}
.filter-btn{padding:3px 10px;border:1px solid #1e3a5f;border-radius:4px;background:transparent;color:#5a6c7d;font-family:inherit;font-size:10px;cursor:pointer;transition:all .2s}
.filter-btn:hover{border-color:#00d4ff;color:#00d4ff}
.filter-btn.active{background:#00d4ff22;border-color:#00d4ff;color:#00d4ff}
.target-list{flex:1;overflow-y:auto}
.cat-header{padding:8px 14px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:2px;position:sticky;top:0;z-index:10;border-bottom:1px solid #1e3a5f}
.cat-quant{background:#1a0a2e;color:#a855f7}
.cat-cloud{background:#0a1e2e;color:#3b82f6}
.cat-finance{background:#1e1a0a;color:#f59e0b}
.cat-custom{background:#0a2e1a;color:#00ff88}
.target-item{padding:8px 14px;border-bottom:1px solid #111827;cursor:pointer;transition:background .2s;display:flex;justify-content:space-between;align-items:center}
.target-item:hover{background:#111827}
.target-item.active{background:#1e293b;border-left:3px solid #00d4ff}
.target-name{font-size:12px;font-weight:500}
.target-host{font-size:9px;color:#5a6c7d;margin-top:1px}
.target-meta{text-align:right}
.target-rtt{font-size:13px;font-weight:700}
.rtt-good{color:#00ff88}.rtt-mid{color:#f59e0b}.rtt-bad{color:#ef4444}
.target-hops{font-size:9px;color:#5a6c7d}
#map{background:#0a0e17;border-bottom:1px solid #1e3a5f}
.detail-panel{background:#0d1321;overflow-y:auto;padding:14px}
.detail-panel::-webkit-scrollbar{width:5px}
.detail-panel::-webkit-scrollbar-track{background:#0d1321}
.detail-panel::-webkit-scrollbar-thumb{background:#1e3a5f;border-radius:3px}
.hop-table{width:100%;border-collapse:collapse;font-size:11px}
.hop-table th{text-align:left;padding:5px 8px;background:#111827;color:#5a6c7d;text-transform:uppercase;letter-spacing:1px;font-size:9px;font-weight:600;position:sticky;top:0}
.hop-table td{padding:4px 8px;border-bottom:1px solid #111827}
.hop-table tr:hover td{background:#111827}
.hop-num{color:#5a6c7d;font-weight:600}
.hop-ip{color:#00d4ff}
.hop-host{color:#c8d6e5;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.hop-loc{color:#818cf8}
.hop-timeout{color:#374151;font-style:italic}
.rtt-bar{height:5px;border-radius:3px;min-width:3px;display:inline-block;vertical-align:middle;margin-right:5px}
.detail-title{font-size:13px;margin-bottom:10px;color:#00d4ff}
.no-select{font-size:12px;color:#374151;padding:30px;text-align:center}
.leaflet-popup-content-wrapper{background:#1a1a2e!important;color:#c8d6e5!important;border:1px solid #1e3a5f!important;border-radius:6px!important;font-family:'SF Mono',monospace!important;font-size:10px!important}
.leaflet-popup-tip{background:#1a1a2e!important}
@media(max-width:768px){.main{grid-template-columns:1fr;grid-template-rows:auto 40vh auto}.sidebar{grid-row:auto;max-height:35vh}.stats{display:none}}
</style>
</head>
<body>

<!-- Toast Container -->
<div id="toast-container" class="toast-container"></div>

<!-- Auth Modal -->
<div id="auth-modal" class="modal-overlay hidden">
  <div class="modal">
    <h2 id="auth-title">Sign In</h2>
    <div id="auth-error" class="error hidden"></div>
    <input id="auth-user" placeholder="Username" autocomplete="username"/>
    <input id="auth-pass" type="password" placeholder="Password" autocomplete="current-password"/>
    <button id="auth-submit" class="btn btn-primary" onclick="submitAuth()">Sign In</button>
    <div class="switch">
      <span id="auth-switch-text">No account? </span>
      <a href="#" id="auth-switch" onclick="toggleAuthMode(event)">Register</a>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div id="settings-modal" class="modal-overlay hidden" onclick="if(event.target===this)hideSettings()">
  <div class="modal settings-modal">
    <h2>Settings</h2>
    <div class="settings-section">
      <h3>Account</h3>
      <div class="settings-row"><span class="settings-label">Username</span><span class="settings-value" id="set-username">-</span></div>
      <div class="settings-row"><span class="settings-label">Member since</span><span class="settings-value" id="set-created">-</span></div>
    </div>
    <div class="settings-section">
      <h3>Subscription</h3>
      <div class="settings-row"><span class="settings-label">Status</span><span id="set-status-badge"></span></div>
      <div class="settings-row"><span class="settings-label">Payment</span><span class="settings-value" id="set-payment">-</span></div>
      <div class="settings-row"><span class="settings-label">Renewal</span><span class="settings-value" id="set-renewal">-</span></div>
      <div id="set-crypto-warning" class="crypto-warning hidden"></div>
    </div>
    <div class="settings-actions">
      <button id="set-btn-billing" class="btn btn-stripe btn-settings hidden" onclick="manageBilling()">Manage Billing</button>
      <button id="set-btn-renew" class="btn btn-settings hidden" onclick="cryptoCheckout()" style="border-color:#f7931a;color:#f7931a;background:#f7931a11">Renew with Crypto</button>
      <button id="set-btn-cancel" class="btn btn-danger btn-settings hidden" onclick="cancelSubscription()">Cancel Subscription</button>
      <button class="btn btn-settings" onclick="doLogout();hideSettings()">Sign Out</button>
    </div>
  </div>
</div>

<div class="header">
  <h1><span class="dot"></span> NETTRACE</h1>
  <div class="header-right">
    <div class="stats">
      <div class="stat-item"><div class="stat-value" id="s-targets">0</div><div class="stat-label">Targets</div></div>
      <div class="stat-item"><div class="stat-value" id="s-hops">0</div><div class="stat-label">Hops</div></div>
      <div class="stat-item"><div class="stat-value" id="s-rtt">-</div><div class="stat-label">Avg RTT</div></div>
      <div class="stat-item"><div class="stat-value" id="s-ips">0</div><div class="stat-label">IPs</div></div>
    </div>
    <div class="user-area">
      <span id="user-badge" class="user-badge hidden"></span>
      <span id="sub-badge" class="sub-badge hidden">PRO</span>
      <button id="btn-settings" class="btn hidden" onclick="showSettings()">Settings</button>
      <button id="btn-auth" class="btn btn-primary" onclick="showAuth()">Sign In</button>
    </div>
  </div>
</div>

<div id="past-due-banner" class="past-due-banner hidden">Payment issue detected. Please update your payment method.</div>

<div class="main">
  <div class="sidebar">
    <!-- Paywall (shown when logged in but not subscribed) -->
    <div id="paywall-section" class="hidden">
      <div class="paywall">
        <h3 id="paywall-title">Unlock Scanning</h3>
        <p id="paywall-subtitle" class="hidden" style="color:#ef4444;font-size:12px;margin-bottom:10px"></p>
        <div class="price">$20<span style="font-size:12px;color:#5a6c7d">/mo</span></div>
        <div class="price-sub">Cancel anytime</div>
        <ul class="features">
          <li>Run unlimited traceroutes from NYC edge</li>
          <li>Real-time hop-by-hop visualization</li>
          <li>Geolocated route mapping</li>
          <li>Scan history & export</li>
        </ul>
        {% if stripe_live %}
        <div id="apple-pay-btn" style="margin-bottom:10px;min-height:44px"></div>
        <button class="btn btn-stripe" onclick="subscribe()" style="width:100%;padding:10px;font-size:13px" id="fallback-subscribe">Pay with Card / Apple Pay / Cash App / PayPal</button>
        <div style="display:flex;gap:6px;justify-content:center;margin-top:8px;opacity:.5;flex-wrap:wrap">
          <span style="font-size:8px;border:1px solid #374151;padding:2px 5px;border-radius:3px">Apple Pay</span>
          <span style="font-size:8px;border:1px solid #374151;padding:2px 5px;border-radius:3px">Cash App</span>
          <span style="font-size:8px;border:1px solid #374151;padding:2px 5px;border-radius:3px">PayPal</span>
          <span style="font-size:8px;border:1px solid #374151;padding:2px 5px;border-radius:3px">Card</span>
        </div>
        {% endif %}
        {% if crypto_live %}
        <button class="btn" onclick="cryptoCheckout()" style="width:100%;padding:10px;font-size:13px;margin-top:8px;border-color:#f7931a;color:#f7931a;background:#f7931a11">Pay with Crypto</button>
        <div style="display:flex;gap:6px;justify-content:center;margin-top:8px;opacity:.5;flex-wrap:wrap">
          <span style="font-size:8px;border:1px solid #f7931a44;padding:2px 5px;border-radius:3px;color:#f7931a">BTC</span>
          <span style="font-size:8px;border:1px solid #627eea44;padding:2px 5px;border-radius:3px;color:#627eea">ETH</span>
          <span style="font-size:8px;border:1px solid #2775ca44;padding:2px 5px;border-radius:3px;color:#2775ca">USDC</span>
          <span style="font-size:8px;border:1px solid #345d9d44;padding:2px 5px;border-radius:3px;color:#345d9d">SOL</span>
          <span style="font-size:8px;border:1px solid #00aae444;padding:2px 5px;border-radius:3px;color:#00aae4">XRP</span>
          <span style="font-size:8px;border:1px solid #c3a63444;padding:2px 5px;border-radius:3px;color:#c3a634">DOGE</span>
        </div>
        {% endif %}
        {% if not stripe_live and not crypto_live %}
        <div style="font-size:11px;color:#374151;padding:10px;text-align:center">Payments coming soon</div>
        {% endif %}
      </div>
    </div>

    <!-- Scan bar (shown when subscribed) -->
    <div id="scan-section" class="hidden">
      <div class="scan-bar">
        <h3>Run Traceroute</h3>
        <div class="scan-input-row">
          <input id="scan-host" placeholder="hostname e.g. api.example.com"/>
          <button class="btn btn-primary" onclick="startScan()">Trace</button>
        </div>
        <div id="scan-status" class="scan-status"></div>
      </div>
      <div class="presets">
        <h3>Quick Targets</h3>
        <div class="preset-chips">
          <span class="preset-chip" onclick="quickScan('api.alpaca.markets','Alpaca')">Alpaca</span>
          <span class="preset-chip" onclick="quickScan('api.polygon.io','Polygon')">Polygon</span>
          <span class="preset-chip" onclick="quickScan('aws.amazon.com','AWS')">AWS</span>
          <span class="preset-chip" onclick="quickScan('cloud.google.com','GCP')">GCP</span>
          <span class="preset-chip" onclick="quickScan('www.nyse.com','NYSE')">NYSE</span>
          <span class="preset-chip" onclick="quickScan('www.bloomberg.com','Bloomberg')">Bloomberg</span>
          <span class="preset-chip" onclick="quickScan('www.cloudflare.com','Cloudflare')">Cloudflare</span>
          <span class="preset-chip" onclick="quickScan('1.1.1.1','Cloudflare DNS')">1.1.1.1</span>
          <span class="preset-chip" onclick="quickScan('8.8.8.8','Google DNS')">8.8.8.8</span>
        </div>
      </div>
    </div>

    <div class="filter-bar">
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="Quant APIs">Quant</button>
      <button class="filter-btn" data-filter="Cloud Providers">Cloud</button>
      <button class="filter-btn" data-filter="NYSE & Financial">Finance</button>
      <button class="filter-btn" data-filter="Custom" id="filter-custom">My Scans</button>
    </div>
    <div id="target-list" class="target-list"></div>
  </div>

  <div id="map"></div>

  <div class="detail-panel" id="detail-panel">
    <div class="no-select">Select a target to view route details &mdash; or sign in & subscribe to run your own</div>
  </div>
</div>

<script>
const STRIPE_PK = "{{ stripe_pk }}";
let DATA=[], userScans=[], currentUser=null, isSubscribed=false;
let socket=null, wsId=null, authMode="login";
let userMeta = {};

const catColors = {
  "Quant APIs":{line:"#a855f7",css:"cat-quant"},
  "Cloud Providers":{line:"#3b82f6",css:"cat-cloud"},
  "NYSE & Financial":{line:"#f59e0b",css:"cat-finance"},
  "Custom":{line:"#00ff88",css:"cat-custom"}
};

const map = L.map("map",{center:[38,-40],zoom:3,zoomControl:false,attributionControl:false});
L.control.zoom({position:"topright"}).addTo(map);
L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{maxZoom:19}).addTo(map);
let routeLayers=L.layerGroup().addTo(map), bgLayers=L.layerGroup().addTo(map);

// ── Toast ──
function showToast(msg, type="success", duration=5000){
  const c=document.getElementById("toast-container");
  const t=document.createElement("div");
  t.className="toast toast-"+type;
  t.textContent=msg;
  c.appendChild(t);
  setTimeout(()=>{t.style.opacity="0";t.style.transition="opacity .3s";setTimeout(()=>t.remove(),300)},duration);
}

// ── Auth ──
function showAuth(){document.getElementById("auth-modal").classList.remove("hidden")}
function hideAuth(){document.getElementById("auth-modal").classList.add("hidden");document.getElementById("auth-error").classList.add("hidden")}
function toggleAuthMode(e){
  e.preventDefault();
  authMode=authMode==="login"?"register":"login";
  document.getElementById("auth-title").textContent=authMode==="login"?"Sign In":"Register";
  document.getElementById("auth-submit").textContent=authMode==="login"?"Sign In":"Register";
  document.getElementById("auth-switch-text").textContent=authMode==="login"?"No account? ":"Have an account? ";
  document.getElementById("auth-switch").textContent=authMode==="login"?"Register":"Sign In";
}
async function submitAuth(){
  const u=document.getElementById("auth-user").value.trim(), p=document.getElementById("auth-pass").value;
  const errEl=document.getElementById("auth-error");
  try{
    const res=await fetch(authMode==="login"?"/api/login":"/api/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:u,password:p})});
    const data=await res.json();
    if(!res.ok){errEl.textContent=data.error;errEl.classList.remove("hidden");return}
    currentUser=data.username; isSubscribed=data.subscribed;
    onLogin(); hideAuth();
  }catch(e){errEl.textContent="Network error";errEl.classList.remove("hidden")}
}
async function doLogout(){
  await fetch("/api/logout",{method:"POST"});
  currentUser=null; isSubscribed=false; userMeta={};
  document.getElementById("btn-auth").classList.remove("hidden");
  ["user-badge","sub-badge","scan-section","paywall-section","btn-settings"].forEach(id=>document.getElementById(id).classList.add("hidden"));
  document.getElementById("past-due-banner").classList.add("hidden");
  userScans=[]; buildSidebar("all");
}

async function fetchUserMeta(){
  try{
    const res=await fetch("/api/me");
    const d=await res.json();
    if(d.authenticated){
      userMeta=d;
      currentUser=d.username;
      isSubscribed=d.subscribed;
    }
    return d;
  }catch(e){return{}}
}

function onLogin(){
  document.getElementById("btn-auth").classList.add("hidden");
  document.getElementById("btn-settings").classList.remove("hidden");
  document.getElementById("user-badge").textContent=currentUser;
  document.getElementById("user-badge").classList.remove("hidden");

  // Past due banner
  if(userMeta.subscription_status==="past_due"){
    document.getElementById("past-due-banner").classList.remove("hidden");
  } else {
    document.getElementById("past-due-banner").classList.add("hidden");
  }

  if(isSubscribed){
    document.getElementById("sub-badge").classList.remove("hidden");
    document.getElementById("scan-section").classList.remove("hidden");
    document.getElementById("paywall-section").classList.add("hidden");
    connectSocket(); loadMyScans();
  } else {
    document.getElementById("sub-badge").classList.add("hidden");
    document.getElementById("scan-section").classList.add("hidden");
    document.getElementById("paywall-section").classList.remove("hidden");
    // Expired crypto paywall
    const st=userMeta.subscription_status;
    if(st==="expired"||st==="cancelled"){
      document.getElementById("paywall-title").textContent="Subscription Expired";
      const sub=document.getElementById("paywall-subtitle");
      sub.textContent="Renew to restore your Pro access.";
      sub.classList.remove("hidden");
    } else {
      document.getElementById("paywall-title").textContent="Unlock Scanning";
      document.getElementById("paywall-subtitle").classList.add("hidden");
    }
    mountApplePay();
  }
}

// ── Settings ──
function showSettings(){
  fetchUserMeta().then(()=>{
    const m=userMeta;
    document.getElementById("set-username").textContent=m.username||"-";
    document.getElementById("set-created").textContent=m.created_at?new Date(m.created_at).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}):"-";

    // Status badge
    const sb=document.getElementById("set-status-badge");
    const st=m.subscription_status||"none";
    const labels={"active":"Active","trialing":"Trialing","past_due":"Past Due","cancelled":"Cancelled","expired":"Expired","canceled":"Cancelled"};
    const classes={"active":"status-active","trialing":"status-active","past_due":"status-past-due","cancelled":"status-cancelled","canceled":"status-cancelled","expired":"status-expired"};
    sb.textContent=labels[st]||"Inactive";
    sb.className="status-badge "+(classes[st]||"status-inactive");

    // Payment method
    const pm=m.payment_method||"none";
    const pmLabels={"stripe":"Card","crypto":"Crypto","none":"-"};
    document.getElementById("set-payment").textContent=pmLabels[pm]||pm;

    // Renewal info
    const renewEl=document.getElementById("set-renewal");
    if(pm==="stripe"&&(st==="active"||st==="trialing"||st==="past_due")){
      renewEl.textContent="Auto-renews monthly";
    } else if(pm==="crypto"&&m.subscription_expires_at){
      renewEl.textContent="Expires "+new Date(m.subscription_expires_at).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"});
    } else {
      renewEl.textContent="-";
    }

    // Crypto expiry warning
    const cw=document.getElementById("set-crypto-warning");
    if(pm==="crypto"&&m.subscription_expires_at&&(st==="active"||st==="cancelled")){
      const days=Math.ceil((new Date(m.subscription_expires_at)-Date.now())/(1000*60*60*24));
      if(days<=7&&days>0){
        cw.textContent="Your subscription expires in "+days+" day"+(days===1?"":"s")+". Renew to keep access.";
        cw.classList.remove("hidden");
      } else if(days<=0){
        cw.textContent="Your subscription has expired.";
        cw.classList.remove("hidden");
      } else {
        cw.classList.add("hidden");
      }
    } else {
      cw.classList.add("hidden");
    }

    // Action buttons
    document.getElementById("set-btn-billing").classList.toggle("hidden",!(pm==="stripe"&&m.has_stripe_billing));
    document.getElementById("set-btn-renew").classList.toggle("hidden",!(pm==="crypto"||st==="expired"||st==="cancelled"||st==="none"));
    document.getElementById("set-btn-cancel").classList.toggle("hidden",!(st==="active"||st==="trialing"||st==="past_due"));

    document.getElementById("settings-modal").classList.remove("hidden");
  });
}
function hideSettings(){document.getElementById("settings-modal").classList.add("hidden")}

async function cancelSubscription(){
  if(!confirm("Cancel your subscription?"))return;
  try{
    const res=await fetch("/api/cancel-subscription",{method:"POST"});
    const data=await res.json();
    if(data.use_portal){
      manageBilling();
      return;
    }
    if(data.ok){
      showToast(data.message||"Subscription cancelled","success");
      hideSettings();
      await fetchUserMeta();
      onLogin();
    } else {
      showToast(data.error||"Could not cancel","error");
    }
  }catch(e){showToast("Network error","error")}
}

// ── Stripe ──
let stripeInstance = null;
function getStripe(){
  if(!stripeInstance && STRIPE_PK) stripeInstance = Stripe(STRIPE_PK);
  return stripeInstance;
}

async function subscribe(){
  try{
    const res=await fetch("/api/create-checkout",{method:"POST",headers:{"Content-Type":"application/json"}});
    const data=await res.json();
    if(data.checkout_url) window.location.href=data.checkout_url;
    else alert(data.error||"Could not start checkout");
  }catch(e){alert("Network error")}
}

function mountApplePay(){
  const s = getStripe();
  if(!s) return;
  const paymentRequest = s.paymentRequest({
    country: "US", currency: "usd",
    total: {label: "NetTrace Pro - Monthly", amount: 2000},
    requestPayerName: true, requestPayerEmail: true
  });
  const prButton = s.elements().create("paymentRequestButton", {paymentRequest, style:{paymentRequestButton:{type:"subscribe",theme:"dark"}}});
  paymentRequest.canMakePayment().then(result => {
    if(result){
      prButton.mount("#apple-pay-btn");
      document.getElementById("fallback-subscribe").style.display="none";
    } else {
      document.getElementById("apple-pay-btn").style.display="none";
    }
  });
  paymentRequest.on("paymentmethod", async (ev) => {
    ev.complete("success");
    subscribe();
  });
}
async function cryptoCheckout(){
  try{
    const res=await fetch("/api/create-crypto-checkout",{method:"POST",headers:{"Content-Type":"application/json"}});
    const data=await res.json();
    if(data.checkout_url) window.location.href=data.checkout_url;
    else alert(data.error||"Could not start crypto checkout");
  }catch(e){alert("Network error")}
}
async function manageBilling(){
  try{
    const res=await fetch("/api/manage-billing",{method:"POST"});
    const data=await res.json();
    if(data.portal_url) window.location.href=data.portal_url;
    else alert(data.error||"Could not open billing");
  }catch(e){alert("Network error")}
}

// ── Checkout return handling ──
(function(){
  const params=new URLSearchParams(window.location.search);
  const subParam=params.get("subscription");
  if(subParam){
    history.replaceState(null,"","/");
    if(subParam==="success"){
      showToast("Payment received! Activating your subscription...","success",8000);
      let attempts=0;
      const poll=setInterval(async()=>{
        attempts++;
        if(attempts>20){clearInterval(poll);return}
        try{
          const res=await fetch("/api/me");const d=await res.json();
          if(d.subscribed){
            clearInterval(poll);
            userMeta=d; currentUser=d.username; isSubscribed=true;
            showToast("Subscription active! You can now run scans.","success");
            onLogin();
          }
        }catch(e){}
      },3000);
    } else if(subParam==="cancelled"){
      showToast("Checkout cancelled","warning");
    }
  }
})();

// ── WebSocket ──
function connectSocket(){
  if(socket)return;
  socket=io({transports:["websocket","polling"]});
  socket.on("connected",d=>{wsId=d.sid});
  socket.on("scan_status",d=>{document.getElementById("scan-status").textContent=d.message;document.getElementById("scan-status").className="scan-status running"});
  socket.on("scan_progress",d=>{document.getElementById("scan-status").textContent=`Tracing... hop ${d.hops_done}/${d.total_hops}`});
  socket.on("scan_complete",d=>{document.getElementById("scan-status").textContent="Scan complete!";document.getElementById("scan-status").className="scan-status done";loadMyScans()});
  socket.on("scan_error",d=>{document.getElementById("scan-status").textContent="Error: "+d.error;document.getElementById("scan-status").className="scan-status err"});
}

// ── Scanning ──
async function startScan(){
  const host=document.getElementById("scan-host").value.trim();
  if(!host)return;
  const el=document.getElementById("scan-status");
  el.textContent="Starting scan...";el.className="scan-status running";
  try{
    const res=await fetch("/api/scan",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host,name:host,sid:wsId})});
    const data=await res.json();
    if(data.needs_subscription){el.textContent="Subscription required";el.className="scan-status err";return}
    if(!res.ok){el.textContent=data.error;el.className="scan-status err";return}
    el.textContent=`Scan #${data.scan_id} started...`;
  }catch(e){el.textContent="Network error";el.className="scan-status err"}
}
function quickScan(h,n){document.getElementById("scan-host").value=h;startScan()}

async function loadMyScans(){
  try{
    const res=await fetch("/api/scans");const scans=await res.json();
    userScans=scans.filter(s=>s.status==="completed"&&s.result).map(s=>({name:s.name||s.host,host:s.host,category:"Custom",hop_count:s.result.hop_count||0,total_rtt:s.result.total_rtt,hops:s.result.hops||[]}));
    buildSidebar(document.querySelector(".filter-btn.active")?.dataset.filter||"all");
    updateStats();drawBgRoutes();
  }catch(e){}
}

// ── Rendering ──
function allData(){return[...DATA,...userScans]}
function updateStats(){
  const all=allData();
  document.getElementById("s-targets").textContent=all.length;
  document.getElementById("s-hops").textContent=all.reduce((s,t)=>s+t.hops.length,0);
  const rtts=all.filter(t=>t.total_rtt).map(t=>t.total_rtt);
  document.getElementById("s-rtt").textContent=rtts.length?(rtts.reduce((a,b)=>a+b,0)/rtts.length).toFixed(1):"-";
  const ips=new Set();all.forEach(t=>t.hops.forEach(h=>{if(h.ip)ips.add(h.ip)}));
  document.getElementById("s-ips").textContent=ips.size;
}
function buildSidebar(filter){
  const list=document.getElementById("target-list");list.innerHTML="";
  const all=allData();
  const filtered=filter==="all"?all:all.filter(d=>d.category===filter);
  let lastCat="";
  const co={"Quant APIs":0,"Cloud Providers":1,"NYSE & Financial":2,"Custom":3};
  filtered.sort((a,b)=>(co[a.category]||9)-(co[b.category]||9)||a.name.localeCompare(b.name));
  filtered.forEach(t=>{
    if(t.category!==lastCat){lastCat=t.category;const h=document.createElement("div");h.className="cat-header "+(catColors[t.category]?.css||"cat-custom");h.textContent=t.category;list.appendChild(h)}
    const item=document.createElement("div");item.className="target-item";
    const idx=all.indexOf(t);item.dataset.index=idx;
    const rc=!t.total_rtt?"rtt-mid":t.total_rtt<30?"rtt-good":t.total_rtt<80?"rtt-mid":"rtt-bad";
    item.innerHTML=`<div><div class="target-name">${t.name}</div><div class="target-host">${t.host}</div></div><div class="target-meta"><div class="target-rtt ${rc}">${t.total_rtt?t.total_rtt.toFixed(1)+" ms":"N/A"}</div><div class="target-hops">${t.hop_count} hops</div></div>`;
    item.addEventListener("click",()=>selectTarget(idx));list.appendChild(item);
  });
}
function drawBgRoutes(){
  bgLayers.clearLayers();
  allData().forEach(t=>{
    const pts=t.hops.filter(h=>h.geo).map(h=>[h.geo.lat,h.geo.lon]);
    if(pts.length>1)L.polyline(pts,{color:catColors[t.category]?.line||"#00ff88",weight:1,opacity:.12}).addTo(bgLayers);
    const last=[...t.hops].reverse().find(h=>h.geo);
    if(last)L.circleMarker([last.geo.lat,last.geo.lon],{radius:3,color:catColors[t.category]?.line||"#00ff88",fillColor:catColors[t.category]?.line||"#00ff88",fillOpacity:.5,weight:1}).bindPopup(`<b>${t.name}</b><br>${t.host}<br>${last.geo.city}, ${last.geo.country}`).addTo(bgLayers);
  });
}
function selectTarget(idx){
  document.querySelectorAll(".target-item").forEach(el=>el.classList.remove("active"));
  document.querySelectorAll(`.target-item[data-index="${idx}"]`).forEach(el=>el.classList.add("active"));
  const t=allData()[idx];if(!t)return;
  const color=catColors[t.category]?.line||"#00d4ff";
  routeLayers.clearLayers();const pts=[];
  t.hops.forEach(h=>{
    if(!h.geo)return;pts.push([h.geo.lat,h.geo.lon]);
    L.circleMarker([h.geo.lat,h.geo.lon],{radius:5,color,fillColor:color,fillOpacity:.8,weight:2})
      .bindPopup(`<b>Hop ${h.hop}</b><br>${h.host}<br><span style="color:#00d4ff">${h.ip}</span><br>${h.geo.city}, ${h.geo.region}, ${h.geo.country}<br>RTT: <b>${h.rtt_ms?h.rtt_ms.toFixed(1)+" ms":"N/A"}</b><br><span style="color:#5a6c7d">${h.geo.isp||""}</span>`)
      .addTo(routeLayers);
  });
  if(pts.length>1){L.polyline(pts,{color,weight:3,opacity:.9}).addTo(routeLayers);L.polyline(pts,{color,weight:8,opacity:.2}).addTo(routeLayers);map.fitBounds(L.latLngBounds(pts).pad(.3))}
  else if(pts.length===1)map.setView(pts[0],6);
  const panel=document.getElementById("detail-panel");
  const maxR=Math.max(...t.hops.filter(h=>h.rtt_ms).map(h=>h.rtt_ms),1);
  const rows=t.hops.map(h=>{
    if(!h.ip)return`<tr><td class="hop-num">${h.hop}</td><td class="hop-timeout" colspan="4">* * * (timeout)</td></tr>`;
    const bw=h.rtt_ms?Math.max(4,(h.rtt_ms/maxR)*100):0;
    const bc=!h.rtt_ms?"#374151":h.rtt_ms<20?"#00ff88":h.rtt_ms<60?"#f59e0b":"#ef4444";
    const loc=h.geo?`${h.geo.city}${h.geo.city&&h.geo.country?", ":""}${h.geo.country}`:"";
    return`<tr><td class="hop-num">${h.hop}</td><td class="hop-ip">${h.ip}</td><td class="hop-host" title="${h.host}">${h.host}</td><td>${h.rtt_ms?`<span class="rtt-bar" style="width:${bw}px;background:${bc}"></span>${h.rtt_ms.toFixed(1)} ms`:"-"}</td><td class="hop-loc">${loc}</td></tr>`;
  }).join("");
  panel.innerHTML=`<div class="detail-title">${t.name} &mdash; ${t.host}</div><table class="hop-table"><thead><tr><th>#</th><th>IP</th><th>Hostname</th><th>RTT</th><th>Location</th></tr></thead><tbody>${rows}</tbody></table>`;
}

document.querySelectorAll(".filter-btn").forEach(b=>b.addEventListener("click",()=>{document.querySelectorAll(".filter-btn").forEach(x=>x.classList.remove("active"));b.classList.add("active");buildSidebar(b.dataset.filter)}));
document.getElementById("scan-host").addEventListener("keydown",e=>{if(e.key==="Enter")startScan()});
document.getElementById("auth-pass").addEventListener("keydown",e=>{if(e.key==="Enter")submitAuth()});
document.getElementById("auth-modal").addEventListener("click",e=>{if(e.target===e.currentTarget)hideAuth()});

async function init(){
  try{
    const res=await fetch("/api/me");const d=await res.json();
    if(d.authenticated){
      userMeta=d; currentUser=d.username; isSubscribed=d.subscribed;
      onLogin();
    }
  }catch(e){}
  try{const res=await fetch("/api/demo");DATA=await res.json()}catch(e){DATA=[]}
  updateStats();buildSidebar("all");drawBgRoutes();
}
init();
</script>
</body>
</html>
