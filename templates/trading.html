<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NetTrace Trading Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'SF Mono','Fira Code','Consolas',monospace;background:#0a0e17;color:#c8d6e5;overflow-x:hidden}
.header{background:linear-gradient(135deg,#0d1321,#1a1a2e);border-bottom:1px solid #1e3a5f;padding:12px 20px;display:flex;align-items:center;justify-content:space-between;height:56px}
.header h1{font-size:16px;color:#00d4ff;letter-spacing:1px;display:flex;align-items:center;gap:8px}
.header h1 .dot{width:8px;height:8px;border-radius:50%;background:#00ff88;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.nav-links{display:flex;gap:12px}
.nav-links a{color:#5a6c7d;text-decoration:none;font-size:12px;padding:4px 10px;border:1px solid transparent;border-radius:4px;transition:all .2s}
.nav-links a:hover,.nav-links a.active{color:#00d4ff;border-color:#00d4ff44}
.container{max-width:1400px;margin:0 auto;padding:20px}
.grid-top{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:16px;margin-bottom:20px}
.card{background:#0d1321;border:1px solid #1e3a5f;border-radius:8px;padding:16px}
.card h3{font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:#5a6c7d;margin-bottom:8px}
.card .big{font-size:28px;font-weight:700}
.card .big.green{color:#00ff88}
.card .big.red{color:#ef4444}
.card .big.blue{color:#00d4ff}
.card .sub{font-size:11px;color:#5a6c7d;margin-top:4px}
.grid-main{display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-bottom:20px}
.chart-card{background:#0d1321;border:1px solid #1e3a5f;border-radius:8px;padding:16px}
.chart-card h3{font-size:12px;color:#00d4ff;margin-bottom:12px}
.holdings-table{width:100%;border-collapse:collapse;font-size:12px}
.holdings-table th{text-align:left;padding:8px 6px;color:#5a6c7d;font-size:10px;text-transform:uppercase;letter-spacing:1px;border-bottom:1px solid #1e3a5f}
.holdings-table td{padding:8px 6px;border-bottom:1px solid #111827}
.holdings-table .amount{color:#c8d6e5}
.holdings-table .usd{color:#00ff88;font-weight:600}
.trades-table{width:100%;border-collapse:collapse;font-size:11px}
.trades-table th{text-align:left;padding:8px 6px;color:#5a6c7d;font-size:10px;text-transform:uppercase;letter-spacing:1px;border-bottom:1px solid #1e3a5f}
.trades-table td{padding:8px 6px;border-bottom:1px solid #111827}
.badge{display:inline-block;padding:2px 6px;border-radius:3px;font-size:10px;font-weight:600}
.badge-buy{background:#00ff8822;color:#00ff88;border:1px solid #00ff8844}
.badge-sell{background:#ef444422;color:#ef4444;border:1px solid #ef444444}
.badge-filled{background:#00d4ff22;color:#00d4ff}
.badge-failed{background:#ef444422;color:#ef4444}
.signal-card{background:#111827;border:1px solid #1e3a5f;border-radius:6px;padding:12px;margin-bottom:8px}
.signal-card .signal-type{font-size:11px;color:#00d4ff;font-weight:600}
.signal-card .signal-host{font-size:10px;color:#5a6c7d;margin-top:2px}
.signal-card .confidence{font-size:18px;font-weight:700;color:#00ff88;float:right}
.refresh-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.refresh-bar .last-update{font-size:11px;color:#5a6c7d}
.refresh-bar .auto-refresh{font-size:11px;color:#00d4ff;cursor:pointer}
.rules-card{background:#0d132180;border:1px solid #fbbf2440;border-radius:8px;padding:16px;margin-bottom:20px}
.rules-card h3{font-size:12px;color:#fbbf24;margin-bottom:8px}
.rules-card ul{list-style:none;font-size:11px;color:#c8d6e5}
.rules-card ul li{padding:3px 0;display:flex;align-items:center;gap:6px}
.rules-card ul li::before{content:'';width:6px;height:6px;border-radius:50%;background:#00ff88;flex-shrink:0}
.rules-card ul li.active::before{background:#00ff88;box-shadow:0 0 6px #00ff88}
.rules-card ul li.breached::before{background:#ef4444;box-shadow:0 0 6px #ef4444}
.pnl-positive{color:#00ff88}
.pnl-negative{color:#ef4444}
@media(max-width:900px){
  .grid-top{grid-template-columns:1fr 1fr}
  .grid-main{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div class="header">
  <h1><span class="dot"></span> NETTRACE TRADING</h1>
  <div class="nav-links">
    <a href="/">Dashboard</a>
    <a href="/status">Status</a>
    <a href="/trading" class="active">Trading</a>
    <a href="/playground">API</a>
  </div>
</div>

<div class="container">
  <div class="refresh-bar">
    <span class="last-update" id="lastUpdate">Loading...</span>
    <span class="auto-refresh" onclick="refreshData()">Refresh Now</span>
  </div>

  <!-- Risk Rules Status -->
  <div class="rules-card">
    <h3>RISK MANAGEMENT RULES</h3>
    <ul>
      <li class="active" id="rule1">Max $5.00 per trade</li>
      <li class="active" id="rule2">Max $2.00 daily loss — stop trading</li>
      <li class="active" id="rule3">10-minute cooldown between same-pair trades</li>
      <li class="active" id="rule4">Only trade with sufficient balance (no margin)</li>
      <li class="active" id="rule5">Signal confidence &gt; 55% required</li>
    </ul>
  </div>

  <!-- Summary Cards -->
  <div class="grid-top">
    <div class="card">
      <h3>Portfolio Value</h3>
      <div class="big green" id="portfolioValue">$--</div>
      <div class="sub" id="portfolioChange">Loading...</div>
    </div>
    <div class="card">
      <h3>Today's P&L</h3>
      <div class="big" id="dailyPnl">$--</div>
      <div class="sub" id="dailyPnlPct">--</div>
    </div>
    <div class="card">
      <h3>Trades Today</h3>
      <div class="big blue" id="tradesToday">--</div>
      <div class="sub" id="tradesTotal">total: --</div>
    </div>
    <div class="card">
      <h3>Active Signals</h3>
      <div class="big blue" id="signalCount">--</div>
      <div class="sub" id="signalConfidence">avg confidence: --</div>
    </div>
  </div>

  <!-- Main Grid -->
  <div class="grid-main">
    <!-- Portfolio Chart -->
    <div class="chart-card">
      <h3>PORTFOLIO VALUE OVER TIME</h3>
      <canvas id="portfolioChart" height="250"></canvas>
    </div>
    <!-- Holdings -->
    <div class="chart-card">
      <h3>HOLDINGS</h3>
      <table class="holdings-table">
        <thead><tr><th>Asset</th><th>Amount</th><th>USD Value</th><th>%</th></tr></thead>
        <tbody id="holdingsBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Trades and Signals -->
  <div class="grid-main">
    <div class="chart-card">
      <h3>RECENT TRADES</h3>
      <table class="trades-table">
        <thead><tr><th>Time</th><th>Pair</th><th>Side</th><th>Price</th><th>Size</th><th>Signal</th><th>Status</th></tr></thead>
        <tbody id="tradesBody"></tbody>
      </table>
      <div id="noTrades" style="text-align:center;padding:20px;color:#5a6c7d;font-size:12px;display:none">
        No trades yet — waiting for high-confidence signals...
      </div>
    </div>
    <div class="chart-card">
      <h3>ACTIVE SIGNALS</h3>
      <div id="signalsContainer">
        <div style="text-align:center;padding:20px;color:#5a6c7d;font-size:12px">Loading signals...</div>
      </div>
    </div>
  </div>
</div>

<script>
let portfolioChart = null;

function initChart() {
  const ctx = document.getElementById('portfolioChart').getContext('2d');
  portfolioChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Portfolio Value ($)',
        data: [],
        borderColor: '#00ff88',
        backgroundColor: 'rgba(0,255,136,0.1)',
        fill: true,
        tension: 0.3,
        pointRadius: 2,
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: {
          ticks: { color: '#5a6c7d', font: { size: 10 }, maxTicksLimit: 12 },
          grid: { color: '#1e3a5f33' }
        },
        y: {
          ticks: { color: '#5a6c7d', font: { size: 10 }, callback: v => '$' + v.toFixed(2) },
          grid: { color: '#1e3a5f33' }
        }
      }
    }
  });
}

async function refreshData() {
  try {
    const resp = await fetch('/api/trading-data');
    const data = await resp.json();
    if (data.error) {
      document.getElementById('lastUpdate').textContent = 'Error: ' + data.error;
      return;
    }
    renderPortfolio(data);
    renderHoldings(data.holdings || {});
    renderTrades(data.trades || []);
    renderSignals(data.signals || []);
    renderChart(data.snapshots || []);
    renderRules(data);
    document.getElementById('lastUpdate').textContent =
      'Last updated: ' + new Date().toLocaleTimeString() +
      (data.snapshot_age ? ' (data age: ' + data.snapshot_age + ')' : '');
  } catch(e) {
    document.getElementById('lastUpdate').textContent = 'Fetch error: ' + e.message;
  }
}

function renderPortfolio(data) {
  const val = data.portfolio_value || 0;
  const pnl = data.daily_pnl || 0;
  const initial = data.initial_value || val;
  const change = val - initial;
  const changePct = initial > 0 ? ((change / initial) * 100).toFixed(2) : '0.00';

  document.getElementById('portfolioValue').textContent = '$' + val.toFixed(2);
  document.getElementById('portfolioChange').textContent =
    (change >= 0 ? '+' : '') + '$' + change.toFixed(2) + ' all time';

  const pnlEl = document.getElementById('dailyPnl');
  pnlEl.textContent = (pnl >= 0 ? '+' : '') + '$' + pnl.toFixed(2);
  pnlEl.className = 'big ' + (pnl >= 0 ? 'green' : 'red');

  const pnlPct = val > 0 ? ((pnl / val) * 100).toFixed(2) : '0.00';
  document.getElementById('dailyPnlPct').textContent = (pnl >= 0 ? '+' : '') + pnlPct + '% today';

  document.getElementById('tradesToday').textContent = data.trades_today || 0;
  document.getElementById('tradesTotal').textContent = 'total: ' + (data.trades_total || 0);
}

function renderHoldings(holdings) {
  const body = document.getElementById('holdingsBody');
  const entries = Object.entries(holdings).sort((a,b) => b[1].usd_value - a[1].usd_value);
  const total = entries.reduce((s, [,d]) => s + d.usd_value, 0);

  if (entries.length === 0) {
    body.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#5a6c7d;padding:20px">No holdings data yet</td></tr>';
    return;
  }

  body.innerHTML = entries.map(([cur, d]) => {
    const pct = total > 0 ? ((d.usd_value / total) * 100).toFixed(1) : '0.0';
    const amt = d.amount < 0.001 ? d.amount.toExponential(3) : d.amount.toFixed(6);
    return `<tr>
      <td><strong>${cur}</strong></td>
      <td class="amount">${amt}</td>
      <td class="usd">$${d.usd_value.toFixed(2)}</td>
      <td>${pct}%</td>
    </tr>`;
  }).join('');
}

function renderTrades(trades) {
  const body = document.getElementById('tradesBody');
  const noTrades = document.getElementById('noTrades');
  if (trades.length === 0) {
    body.innerHTML = '';
    noTrades.style.display = 'block';
    return;
  }
  noTrades.style.display = 'none';
  body.innerHTML = trades.slice(0, 20).map(t => {
    const time = t.created_at ? new Date(t.created_at).toLocaleTimeString() : '--';
    const sideClass = t.side === 'BUY' ? 'badge-buy' : 'badge-sell';
    const statusClass = t.status === 'filled' ? 'badge-filled' : 'badge-failed';
    return `<tr>
      <td>${time}</td>
      <td>${t.pair}</td>
      <td><span class="badge ${sideClass}">${t.side}</span></td>
      <td>$${(t.price || 0).toFixed(2)}</td>
      <td>$${(t.total_usd || 0).toFixed(2)}</td>
      <td style="font-size:10px">${t.signal_type || '--'}</td>
      <td><span class="badge ${statusClass}">${t.status}</span></td>
    </tr>`;
  }).join('');
}

function renderSignals(signals) {
  const container = document.getElementById('signalsContainer');
  document.getElementById('signalCount').textContent = signals.length;
  if (signals.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:20px;color:#5a6c7d;font-size:12px">No active signals</div>';
    document.getElementById('signalConfidence').textContent = 'waiting for signals...';
    return;
  }
  const avgConf = signals.reduce((s,sig) => s + (sig.confidence || 0), 0) / signals.length;
  document.getElementById('signalConfidence').textContent = 'avg confidence: ' + (avgConf * 100).toFixed(0) + '%';

  container.innerHTML = signals.slice(0, 8).map(sig => `
    <div class="signal-card">
      <span class="confidence">${((sig.confidence || 0) * 100).toFixed(0)}%</span>
      <div class="signal-type">${sig.signal_type || 'unknown'}</div>
      <div class="signal-host">${sig.target_host || '--'} | ${sig.direction || '--'}</div>
    </div>
  `).join('');
}

function renderChart(snapshots) {
  if (!portfolioChart || snapshots.length === 0) return;
  const sorted = snapshots.sort((a,b) => new Date(a.recorded_at) - new Date(b.recorded_at));
  portfolioChart.data.labels = sorted.map(s => {
    const d = new Date(s.recorded_at);
    return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  });
  portfolioChart.data.datasets[0].data = sorted.map(s => s.total_value_usd);
  portfolioChart.update();
}

function renderRules(data) {
  const pnl = data.daily_pnl || 0;
  if (pnl <= -2.0) {
    document.getElementById('rule2').classList.add('breached');
    document.getElementById('rule2').classList.remove('active');
  }
}

// Init
initChart();
refreshData();
setInterval(refreshData, 30000); // refresh every 30s
</script>
</body>
</html>
